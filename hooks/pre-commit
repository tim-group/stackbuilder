#!/bin/sh

echo -n "Running rake spec: "
SPEC_OUTPUT=`rake spec 2>&1`
if [ $? -ne 0 ]; then
	echo "[31mFAIL[0m" >&2
	echo "$SPEC_OUTPUT" >&2
	exit 1
else
	echo "[32mOK[0m"
fi

if which rubocop > /dev/null; then
	# check only touched files
	tmpdir=$(mktemp -d pre-commit.XXXXXXXXXX)
	trap "rm -rf $tmpdir" EXIT

	git diff --cached --name-only --diff-filter=ACM \
	 | git checkout-index --stdin --prefix=$tmpdir/

	rubocop $tmpdir/ || exit 1
else
	echo "[31mrubocop not found[0m" >&2
	exit 1
fi

dpkg -s stackbuilder 2>&1 >/dev/null

if [ $? -eq 0 ]; then
  echo "The stackbuilder package is installed..."
  echo "Ensuring it's the local copy."
  rake package install
  echo -n "Running stacks compile: "
  OUTPUT=`stacks compile > /tmp/stacks-pre-commit`
  RC=$?
  if [ $RC -ne 0 ]; then
    echo "FAIL"
    echo "$OUTPUT"
    exit 1
  else
    echo "OK"
  fi
fi
