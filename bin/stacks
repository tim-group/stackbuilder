#!/opt/ruby-bundle/bin/ruby
#
# stacks COMMAND [arguments]
#
# Use -p PATH, or the environmental variable STACKBUILDER_CONFIG_PATH to specify stackbuilder-config path. The default
# is '/etc/stacks'
#

$LOAD_PATH << '/usr/local/lib/site_ruby/timgroup/'

require 'optparse'

require 'stackbuilder/stacks/factory'
require 'stackbuilder/support/logger'

$options = {
  :environment => 'dev',
  :path        => ENV['STACKBUILDER_CONFIG_PATH'] || '/etc/stacks',
  :verbose     => 1
}

cmd = ARGV.shift
OptionParser.new do |opts|
  opts.banner = 'Usage: example.rb [options]'

  opts.on('-e', '--environment ENVIRONMENT', 'specify environment') do |env|
    $options[:environment] = env
  end
  opts.on('-p', '--path PATH', 'specify stackbuilder-config path') do |path|
    $options[:path] = path
  end
  opts.on('-v', '--verbose', 'run verbosely') do
    $options[:verbose] += 1
  end
end.parse!
args = ARGV
logger(Logger::DEBUG) { "finished processing options. command: #{cmd}, options: #{$options}, args: #{args}" }

logger(Logger::DEBUG) { 'initializing $factory' }
$factory = Stacks::Factory.new
if (environment = $factory.inventory.find_environment($options[:environment])).nil?
  logger(Logger::ERROR) { "environment \"#{$options[:environment]}\" not found" }
  exit 1
end
logger(Logger::DEBUG) { "environment \"#{environment.name}\" has #{environment.definitions.count} definitions" }

logger(Logger::DEBUG) { "about to execute command \"#{cmd}\"" }
case cmd
when 'audit'
  require 'stackbuilder/support/cmd_audit'
  logger(Logger::DEBUG) { ":primary_site for \"#{environment.name}\" is \"#{environment.options[:primary_site]}\"" }

  CMDAudit.audit(environment.options[:primary_site])
when 'dump_enc'
  require 'stackbuilder/support/zamls'
  $factory.inventory.environments.sort.each do |envname, env|
    next if envname == 'lon' # XXX 15.07.15 mmazurek/scarytom: special case 'lon' until it's fixed
    env.flatten.sort { |a, b| a.hostname + a.domain <=> b.hostname + b.domain }.each do |stack|
      puts "running to_enc on #{stack.hostname}.#{stack.domain}/#{envname}:"
      puts ZAMLS.to_zamls(stack.to_enc)
    end
  end
when 'dump_spec'
  require 'stackbuilder/support/zamls'
  $factory.inventory.environments.sort.each do |envname, env|
    next if envname == 'lon' # XXX 15.07.15 mmazurek/scarytom: special case 'lon' until it's fixed
    env.flatten.sort { |a, b| a.hostname + a.domain <=> b.hostname + b.domain }.each do |stack|
      puts "running to_spec on #{stack.hostname}.#{stack.domain}/#{envname}:"
      puts ZAMLS.to_zamls(stack.to_spec)
    end
  end
when 'find_rogue'
  # find inconsistency between stackbuilder-config and reality
  require 'stackbuilder/support/cmd_find_rogue'
  defined_hostnames, _defined_machines = CMDFindRogue.get_defined_machines(environment)
  allocated_hostnames, _allocated_domains, _allocated_storage = CMDFindRogue.get_allocated_machines(%w(oy pg st ci))

  CMDFindRogue.rogue_check_allocation(defined_hostnames, allocated_hostnames)
  # rogue_check_resources(defined_machines, allocated_domains)
  # rogue_check_missing_storage(defined_machines, allocated_storage, allocated_hostnames)
when 'ls'
  require 'stackbuilder/support/cmd_ls'
  CMDLs.ls(environment)
else
  logger(Logger::FATAL) { "invalid command \"#{cmd}\"" }
  exit 1
end

logger(Logger::DEBUG) { 'exiting gracefuly' }
